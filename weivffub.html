list_login_token = []

def get_login_token():
    global list_login_token
    if len(list_login_token) != 0:
        return random.choice(list_login_token)
    else:
        h = {
            'Accept-Encoding':'gzip, deflate, br',
            'Accept-Language':'vi,en-US;q=0.9,en;q=0.8',
            'Content-Length':'2',
            'Content-Type':'application/json',
            'Gjw-Did':'1gjmbv5jtr91QJHTAAVmXmU5O12r0d',
            'Gjw-Sign':'ca57245fae3b3a03d6eaadb1cef531b4',
            'Gjw-Ts':'1710510510579',
            'Origin':'https://www.ganjingworld.com',
            'Referer':'https://www.ganjingworld.com/',
            'Sec-Ch-Ua':'"Chromium";v="122", "Not(A:Brand";v="24", "Microsoft Edge";v="122"',
            'Sec-Ch-Ua-Mobile':'?0',
            'Sec-Ch-Ua-Platform':'"Windows"',
            'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0',
            'X-Cdk-Dsid':'1b9be33b-2263-79b6-7da2-6fb5f24efc55',
            'X-Cdk-Lrtm':'2024-03-15 20:48:30',
        }
        global_proxy = None
        while True:
            if len(list_login_token) != 0:
                return random.choice(list_login_token)
            try:
                token = requests.post("https://gw.ganjingworld.com/v1.0c/auth/guest/registration", json={}, headers=h, proxies=global_proxy).json()["data"]["accessToken"]
                list_login_token.append(token)
                return token
            except: pass
h = {
            'Accept-Encoding':'gzip, deflate, br',
            'Accept-Language':'vi,en-US;q=0.9,en;q=0.8',
            'Content-Length':'2',
            'Content-Type':'application/json',
            'Gjw-Did':'1gjmbv5jtr91QJHTAAVmXmU5O12r0d',
            'Gjw-Sign':'ca57245fae3b3a03d6eaadb1cef531b4',
            'Gjw-Ts':'1710510510579',
            'Origin':'https://www.ganjingworld.com',
            'Referer':'https://www.ganjingworld.com/',
            'Sec-Ch-Ua':'"Chromium";v="122", "Not(A:Brand";v="24", "Microsoft Edge";v="122"',
            'Sec-Ch-Ua-Mobile':'?0',
            'Sec-Ch-Ua-Platform':'"Windows"',
            'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0',
            'X-Cdk-Dsid':'1b9be33b-2263-79b6-7da2-6fb5f24efc55',
            'X-Cdk-Lrtm':'2024-03-15 20:48:30',
        }
try:
    token = requests.post("https://gw.ganjingworld.com/v1.0c/auth/guest/registration", json={}, headers=h).json()["data"]["accessToken"]
    list_login_token.append(token)
except: 
    pass

list_uid = []
list_duration = []

def buff_view(url, index):
    global running, view, list_uid, list_duration
    def my_ip():
        try:
            ip = requests.get("https://api.ipify.org").text
            return ip
        except:
            return "Unable to get your IP"

    def get_proxy():
        key = random.choice(['f527a2d0-f831-b98a-827259a3c6be','3257208e-c61d-806d-b282fb7cb975','16f46cb8-bb37-af85-0610f8f5e626','1f0d3a6d-160b-8adb-25149423ca4a','e1db9c5a-b893-aa50-65dc5af552f7','e4caefa1-cc8f-9576-4cd75b80af62'])
        a = requests.get(f"https://apikey.site/key/get-new-ip?key={key}").json()
        if a["message"] == "SUCCESS":
            if a["data"]["authIp"] == my_ip():
                return f'{a["data"]["host"]}:{a["data"]["port"]}'
            else:
                get_proxy()
        elif a["message"] == "GET_IP_TOO_FAST":
            a = requests.get(f"https://apikey.site/key/get-current-ip?key={key}").json()
            if a["data"]["authIp"] == my_ip():
                return f'{a["data"]["host"]}:{a["data"]["port"]}'
            else:
                get_proxy()
        else:
            
            get_proxy()
    while True:
        try:
            pr = get_proxy()
            p = {
                "http":f"http://{pr}",
                "https":f"http://{pr}"
            }
            break
        except:
            time.sleep(1)
    running[index] = [f"Loading", url, "Đang lấy thông tin video"]
    uid = url.split("/")[-1]
    if uid not in list_uid:
        list_uid.append(uid)
    token = get_login_token()

    d = {
        "id":uid,
    }
    h = {
        "Authorization":token,
    }

    running[index] = ["Loading", url, "Lấy thông tin thành công"]
    current_view = 0
    while True:
        def my_ip():
            try:
                ip = requests.get("https://api.ipify.org").text
                return ip
            except:
                return "Unable to get your IP"

        def get_proxy():
            key = random.choice(['f527a2d0-f831-b98a-827259a3c6be','3257208e-c61d-806d-b282fb7cb975','16f46cb8-bb37-af85-0610f8f5e626','1f0d3a6d-160b-8adb-25149423ca4a','e1db9c5a-b893-aa50-65dc5af552f7','e4caefa1-cc8f-9576-4cd75b80af62'])
            a = requests.get(f"https://apikey.site/key/get-new-ip?key={key}").json()
            if a["message"] == "SUCCESS":
                if a["data"]["authIp"] == my_ip():
                    return f'{a["data"]["host"]}:{a["data"]["port"]}'
                else:
                    return get_proxy()
            elif a["message"] == "GET_IP_TOO_FAST":
                a = requests.get(f"https://apikey.site/key/get-current-ip?key={key}").json()
                if a["data"]["authIp"] == my_ip():
                    return f'{a["data"]["host"]}:{a["data"]["port"]}'
                else:
                    return get_proxy()
            else:
                
                return get_proxy()


        while True:
            try:
                pr = get_proxy()
                p = {
                    "http":f"http://{pr}",
                    "https":f"http://{pr}"
                }
                break
            except:
                time.sleep(1)
        try:
            running[index] = ["Sending view", url, f"{current_view} views"]
            count = requests.post("https://gw.ganjingworld.com/v1.0c/set-view-count", json=d, headers=h, proxies=p).json()

            if count["data"]["view_count"]>current_view:
                current_view = count["data"]["view_count"]
                running[index] = ["Sent view successfully", url, f"{count['data']['view_count']} views"]
            else:
                running[index] = ["Sending view", url, f"{current_view} views"]
            if view<=current_view:
                running[index]=["Send view complete", url, f"{current_view} views"]
                break

            time.sleep(delay)
        except Exception as e:
            open("error.txt", "a").write(f"{str(e)}\n")
            running[index] = ["Sent view unsuccessfully", url, f"{current_view} views"]
            time.sleep(delay)

def checking():
    global running, success, custom, slg_acc, start_time, status
    while status:
        for j in range(len(running)):
            if running[j][0]=="Sent view successfully":
                print(f"\033[32mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
            elif running[j][0]=="Sending view":
                print(f"\033[33mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
            elif running[j][0]=="Sent view unsuccessfully":
                print(f"\033[31mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
            else:
                print(f"\033[36mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
        end_time = time.time()

        execution_time = end_time - start_time
        hours, rem = divmod(execution_time, 3600)
        minutes, seconds = divmod(rem, 60)
        formatted_time = "{:0>2}:{:0>2}:{:05.2f}".format(int(hours),int(minutes),seconds)

        print(f"\033[33mProcess: {formatted_time}\033[0m")
        time.sleep(1)
        os.system('cls')
    

list_token = []

def get_video(channel):

    channel_id = channel.split('/')[-1].split('?')[0]

    try: 
        token = random.choice(list_token)
    except:

        h = {
            'Accept':'application/json, text/plain, */*',
            'Accept-Encoding':'gzip, deflate, br',
            'Accept-Language':'vi,en-US;q=0.9,en;q=0.8',
            'Content-Length':'2',
            'Content-Type':'application/json',
            'Gjw-Did':'1gjmbv5jtr91QJHTAAVmXmU5O12r0d',
            'Gjw-Sign':'0e672e93014dec4954943be0dddbdc1e',
            'Gjw-Ts':'1711134553944',
            'X-Cdk-Dsid':'1b9be33b-2263-79b6-7da2-6fb5f24efc55',
            'X-Cdk-Lrtm':'2024-03-23 02:09:13',
            'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36 Edg/122.0.0.0',
        }

        token = requests.post("https://gw.ganjingworld.com/v1.0c/auth/guest/registration", json={}, headers=h).json()["data"]["accessToken"]
        list_token.append(token)
    url  = f"https://gw.ganjingworld.com/v1.1/content/get-by-channel?lang=en-US&start_key=&channel_id={channel_id}&page_size=8&content_type=Video&include_hidden=true&query=basic,view&visibility=public&mode=ready"
    try:
        h = {
            "Authorization":token
        }

        list_url = []

        while True:
            try:
                a = requests.get(url, headers=h).json().get("data")
                j = a["list"]
                for i in j:
                    uid = i["id"]
                    list_url.append(f"https://www.ganjingworld.com/video/{uid}")
                if a["start_key"]!="":
                    url  = f"https://gw.ganjingworld.com/v1.1/content/get-by-channel?lang=en-US&start_key={a["start_key"]}&channel_id={channel_id}&page_size=8&content_type=Video&include_hidden=true&query=basic,view&visibility=public&mode=ready"
                else: break
            except: break
        return list_url
    except: 
        try: list_token.remove(token)
        except: pass
        return get_video(channel)

while True:
    try:
        a = input("Enter to import file")
        list_open = open(filedialog.askopenfilename(title="Select file", filetypes=(("Text files", "*.txt"),("all files", "*.*"))), "r", encoding="utf-8", errors="replace").read().split("\n")
        break
    except:
        os.system("cls")
        pass
print("Đang nhập video...")
list_url = []
for i in list_open:
    if "/video/" in i:
        list_url.append(i)
    elif "/channel/" in i:
        list_url+=get_video(i)
os.system("cls")
print(f"Đã tìm thấy {len(list_url)} video")
view = int(input("Enter the number of views: "))
delay = int(input("Enter the delay time (s): "))
luong = int(input("Enter the number of threads: "))
os.system("cls")
running = [['','',''] for _ in range(luong)]
status = True
start_time = time.time()
t = threading.Thread(target=checking)
t.start()
for i in range(0, len(list_url), luong):
    threads = []
    aaa = list_url[i:i+luong]
    index = 0
    for i in aaa:
        threads.append(threading.Thread(target=buff_view, args=(i,index)))
        index+=1
    for j in threads:
        j.start()
    for j in threads:
        j.join()
    print("--------------------")
    print(f"Sent view to {len(aaa)} videos complete")
    print("--------------------")
status = False
t.join()
end_time = time.time()

execution_time = end_time - start_time
hours, rem = divmod(execution_time, 3600)
minutes, seconds = divmod(rem, 60)
formatted_time = "{:0>2}:{:0>2}:{:05.2f}".format(int(hours),int(minutes),seconds)
print(f"\033[32mProcess: {formatted_time}\033[0m  | Sent view complete")
end = input("Press Enter to exit")
