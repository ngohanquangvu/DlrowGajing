os.environ["PLAYWRIGHT_BROWSERS_PATH"] = "./ms-playwright"

proxy_server = f'http://usa.rotating.proxyrack.net:{random.randint(9000,9050)}'
username = 'tenica'
password = 'MZ1Q5XU-QCJFZEO-LKSA1T2-RLBJWQQ-DY5OE8P-XPQTPYI-S1QXJW6'

def run(playwright, dem, index, lock):
    global list_url, running, url_complete, timeout, delay
    headless = False
    browser = playwright.firefox.launch(proxy={
        "server": proxy_server,
        "username": username,
        "password": password
    }, headless=headless)
    while True:
        click = 0
        with lock:
            if len(list_url) == 0:
                break
            url = list_url.pop(0)
        while click < dem:  # Số lần truy cập lại URL
            running[index] = ["Clicking", url, click]
            context = browser.new_context()
            page = context.new_page()
            refresh_count = 0
            max_refresh = 5

            while True:
                try:
                    page.goto(url, timeout=30000, wait_until="domcontentloaded")

                    # Thời gian timeout để kiểm tra video
                    check_timeout = timeout
                    start_time = time.time()
                    video_playing = False

                    while time.time() - start_time < check_timeout:
                        video_playing = page.evaluate("""
                            (function() {
                                var videos = document.querySelectorAll('video');
                                for (var i = 0; i < videos.length; i++) {
                                    if (!videos[i].paused) {
                                        return true;
                                    }
                                }
                                return false;
                            })();
                        """)
                        if video_playing:
                            break
                        time.sleep(1)  # Chờ một giây trước khi kiểm tra lại

                        # Nếu trang đã load hoàn toàn mà video không phát, reload lại trang
                        if page.evaluate("document.readyState") == "complete" and not video_playing:
                            refresh_count += 1
                            if refresh_count > max_refresh:
                                print(f"Failed to load video after {max_refresh} refreshes, closing page.")
                                page.close()
                                context.close()
                                break
                            page.reload()
                            start_time = time.time()  # Reset lại thời gian bắt đầu kiểm tra

                    if refresh_count > max_refresh:
                        continue

                    # Cuộn xuống một độ cao ngẫu nhiên sau khi video đã phát
                    if video_playing:
                        scroll_height = page.evaluate("document.documentElement.scrollHeight")
                        random_scroll_height = random.randint(0, scroll_height)
                        page.evaluate(f"window.scrollTo(0, {random_scroll_height});")
                        time.sleep(1)

                        # Bấm vào một URL bất kỳ trong trang
                        elements = page.query_selector_all("a[href]")
                        if elements:
                            random_element = random.choice(elements)
                            random_element.click()
                        time.sleep(delay)

                    page.close()
                    context.close()
                    running[index] = ["Click Success", url, click]
                    click += 1
                    break
                except Exception as e:
                    print(f"Error: {e}")
                    page.close()
                    context.close()
                    break
        url_complete += 1
    browser.close()
    running[index] = ["Done", "", ""]

def process_url(dem, index, lock):
        with sync_playwright() as playwright:
            run(playwright, dem, index, lock)

def checking():
    global url_complete, running, start_time, status
    while status:
        for j in range(len(running)):
            if running[j][0]=="Click Success" or running[j][0]=="Done":
                print(f"\033[32mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
            elif running[j][0]=="Clicking":
                print(f"\033[33mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
            else:
                print(f"\033[36mThread {j+1}: {running[j][0]} | {running[j][1]} | {running[j][2]}\033[0m")
                print("")
        end_time = time.time()

        execution_time = end_time - start_time
        hours, rem = divmod(execution_time, 3600)
        minutes, seconds = divmod(rem, 60)
        formatted_time = "{:0>2}:{:0>2}:{:05.2f}".format(int(hours),int(minutes),seconds)

        print(f"\033[33mProcess: {formatted_time} - Url complete: {url_complete}\033[0m")
        time.sleep(1)
        os.system('cls')


start_tool = input("Enter để băt đầu...")
list_url = askopenfilename(title="Chọn file chứa danh sách URL cần truy cập", filetypes=[("Text files", "*.txt")])
list_url = [line.strip() for line in open(list_url, "r").readlines()]
print(f"Data: {len(list_url)} urls")
while True:
    try:
        dem = int(input("Nhập số lần truy cập: "))
        break
    except ValueError:
        print("Số lần truy cập phải là số nguyên")
        continue
while True:
    try:
        luong = int(input("Nhập số luồng: "))
        break
    except ValueError:
        print("Số luồng phải là số nguyên")
        continue
while True:
    try:
        timeout = int(input("Nhập timeout(s): "))
        break
    except ValueError:
        print("Số timeout phải là số nguyên")
        continue

while True:
    try:
        delay = int(input("Nhập thời gian treo tab(s): "))
        break
    except ValueError:
        print("Số thời gian treo tab phải là số nguyên")
        continue


url_complete = 0
running = [['','',''] for _ in range(luong)]
lock = threading.Lock()
status = True
start_time = time.time()
t = threading.Thread(target=checking)
t.start()
threads = []
for i in range(luong):
    thread = threading.Thread(target=process_url, args=(dem, i, lock))
    threads.append(thread)
    thread.start()
for thread in threads:
    thread.join()
t.join()
end_time = time.time()

execution_time = end_time - start_time
hours, rem = divmod(execution_time, 3600)
minutes, seconds = divmod(rem, 60)
formatted_time = "{:0>2}:{:0>2}:{:05.2f}".format(int(hours),int(minutes),seconds)

print(f"\033[33mProcess: {formatted_time}\033[0m")
output = input("Nhấn Enter để thoát...")
status = False
